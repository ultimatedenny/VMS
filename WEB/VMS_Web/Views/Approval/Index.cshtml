
@{
    ViewBag.Title = "Approval";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
@Scripts.Render("~/Mousetrap")
@Scripts.Render("~/Webcam")
@Styles.Render("~/DataTablesCS")
@Scripts.Render("~/DataTablesJS")

<style scoped>
   

    .k-textboxlarge {
        height: 40px;
        width: 100%;
        font-size: 20px;
    }
    .k-grid {
        overflow-x: auto;
        white-space: nowrap;
    }

    td.details-control {
        background: url('@Url.Content("~/Content/Images/details_open.png")') no-repeat center center;
        cursor: pointer;
    }

    tr.shown td.details-control {
        background: url('@Url.Content("~/Content/Images/details_close.png")') no-repeat center center;
    }
</style>
<script>
    
    function showMyTask() {
        $.ajax({
            //url: "../Approval/ShowRequestApproval",
            url: '@Url.Action("ShowRequestApproval", "Approval")',
            method: "POST",
            dataType: "JSON",
            data: {
            },
            success: function (j) {
                //console.log(j.xdataTable);
                myTaskGrid.mDataTable.clear();
                $.each(j.xdataTable, function (i, st) {
                    myTaskGrid.mDataTable.row.add(st);
                })
                myTaskGrid.mDataTable.draw();
            },
            error: function (xhr, error, text) {
                toastr.error("Failed Query Get View Table, Please contact IT")
            }
        });
        $('#rowMyTask').show();
        @*var table = $("#myTaskGrid").DataTable({
            destroy: true,
            "scrollX": true,
            "processing": true, // for show progress bar
            "serverSide": true, // for process server side
            "filter": false, // this is for disable filter (search box)
            "orderMulti": false, // for disable multiple column at once
            "pageLength": 10,
            "ajax": {
                "url": "@Url.Action("ShowRequestApproval", "Approval")",
                "type": "POST",
                "datatype": "json",
                //"data": function (d) {
                //    return $.extend({}, d, {
                //        "Name": Name
                //    });
                //}
            },
                // Commented by CANICE 20210801
                //"columnDefs":
                //[{
                //    "targets": [0],
                //    "visible": false,
                //    "searchable": false
                //},
                //{
                //    "targets": [11],
                //    "searchable": false,
                //    "orderable": false
                //}],
                //End Commented 20210801

    "columns": [
        
        //{ "data": "LogId", "name": "LogId", "autoWidth": true }, // Commented by CANICE 20210801 Moved to 3rd column 
        {
            "data": "No",
            render: function (data, type, row, meta) {
                return meta.row + meta.settings._iDisplayStart + 1;
            }
        },
        {
            "render": function (data, type, full, meta) {
                return '<button class="btn btn-info"  onclick="ApproveVisitor(' + full.LogId + ')"><i class="fa fa-1x fa-check-circle"></i> Approve</button> - <button class="btn btn-danger"  onclick="RejectVisitor(' + full.LogId + ')"><i class="fa fa-1x fa-times-circle"></i> Reject</button>';
            }
        },
        { "data": "LogId", "name": "LogId", "title": "RefNo", "autoWidth": true }, // Added by CANICE 20210801
        { "data": "Area", "name": "Area", "title": "Area", "autoWidth": true },
        { "data": "VisitorType", "name": "VisitorType", "title": "Visitor Type", "autoWidth": true },
        { "data": "HostName", "name": "HostName", "title": "Host Name", "autoWidth": true },
        { "data": "FullName", "name": "FullName", "title": "Visitor Name", "autoWidth": true },
        { "data": "Remark", "name": "Remark", "title": "Remark", "autoWidth": true },
        { "data": "DateStart", "name": "DateStart", "title": "Date Start", "autoWidth": true },
        { "data": "DateEnd", "name": "DateEnd", "title": "Date End", "autoWidth": true },
        { "data": "TimeStart", "name": "TimeStart", "title": "Time Start", "autoWidth": true },
        { "data": "TimeEnd", "name": "TimeEnd", "title": "Time End", "autoWidth": true },
        { "data": "Status", "name": "Status", "title": "Status", "autoWidth": true },
        

    ]
    }
        );*@
        
    }
    
</script>
<script>
    function showMyHistoryTask() {
        $('#myHistoryGrid').show("slow");
        var table = $("#myHistoryGrid").DataTable({
            destroy: true,
            "scrollX": true,
            "processing": true, // for show progress bar
            "serverSide": true, // for process server side
            "filter": false, // this is for disable filter (search box)
            "orderMulti": false, // for disable multiple column at once
            "pageLength": 10,
            "ajax": {
                "url": '@Url.Action("ShowHistoryApproval", "Approval") ',
                "type": "POST",
                "datatype": "json",
                //"data": function (d) {
                //    return $.extend({}, d, {
                //        "Name": Name
                //    });
                //}
             },

                "columnDefs":
                [{
                    "targets": [0],
                    "visible": true,
                    "searchable": false
                },
                {
                    "targets": [1],
                    "searchable": false,
                    "orderable": false
                }],

    "columns": [

        {
            "data": "No",
            render: function (data, type, row, meta) {
                return meta.row + meta.settings._iDisplayStart + 1;
            }
        },
        { "data": "LogId", "name": "LogId", "title": "RefNo", "autoWidth": true }, // Added by CANICE 20210801
        { "data": "Area", "name": "Area", "title": "Area", "autoWidth": true },
        { "data": "VisitorType", "name": "VisitorType", "title": "Visitor Type", "autoWidth": true },
        { "data": "HostName", "name": "HostName", "title": "Host Name", "autoWidth": true },
        { "data": "FullName", "name": "FullName", "title": "Visitor Name", "autoWidth": true },
        { "data": "Remark", "name": "Remark", "title": "Remark", "autoWidth": true },
        { "data": "DateStart", "name": "DateStart", "title": "Date Start", "autoWidth": true },
        { "data": "DateEnd", "name": "DateEnd", "title": "Date End", "autoWidth": true },
        { "data": "TimeStart", "name": "TimeStart", "title": "Time Start", "autoWidth": true },
        { "data": "TimeEnd", "name": "TimeEnd", "title": "Time End", "autoWidth": true },
        { "data": "Status", "name": "Status", "title": "Status", "autoWidth": true },


    ]
    }
        );
    }
</script>
<script>
    function ShowMyRequest()
    {
        $.ajax({
            //url: "../Approval/ShowMyRequest",
            url: '@Url.Action("ShowMyRequest", "Approval")',
            method: "POST",
            dataType: "JSON",
            data: {
            },
            success: function (j) {
                console.log(j.xdataTable);
                MyRequest.mDataTable.clear();
                $.each(j.xdataTable, function (i, st) {
                    MyRequest.mDataTable.row.add(st);
                })
                MyRequest.mDataTable.draw();
            },
            error: function (xhr, error, text) {
                toastr.error("Failed Query Get View Table, Please contact IT")
            }
        });
    }
</script>
<script>
    function ShowHistoryMyTask() {
        $.ajax({
            //url: "../Approval/ShowHistoryMyTask",
            url: '@Url.Action("ShowHistoryMyTask", "Approval")',
            method: "POST",
            dataType: "JSON",
            data: {
            },
            success: function (j) {
                //console.log(j.xdataTable);
                myHistoryGrid.mDataTable.clear();
                $.each(j.xdataTable, function (i, st) {
                    myHistoryGrid.mDataTable.row.add(st);
                })
                myHistoryGrid.mDataTable.draw();
            },
            error: function (xhr, error, text) {
                toastr.error("Failed Query Get View Table, Please contact IT")
            }
        });
    }
</script>
<div class="row" id="rowMyTask" >
    <div class="col-md-12" id="BoxMyTask">
        <div class="box ShimanoBox">
            <div class="box-header">
                My Task
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"
                            title="Collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <div class="row">
                    <div class="col-md-12">
                        <div style="width:100%; margin:0 auto;">
                            <table id="myTaskGrid" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        @*<th>LogId</th>
                                            <th>No</th>
                                            <th>Action</th>
                                            <th>LogId</th>
                                            <th>Area</th>
                                            <th>Visitor Type</th>
                                            <th>Host Name</th>
                                            <th>Visitor Name</th>
                                            <th>Remark</th>
                                            <th>DateStart</th>
                                            <th>DateEnd</th>
                                            <th>TimeStart</th>
                                            <th>TimeEnd</th>
                                            <th>Status</th>*@
                                        <th></th>
                                        <th>No</th>
                                        <th>Action</th>
                                        <th>RefNo.</th>
                                        <th>Area</th>
                                        <th>Visitor Type</th>
                                        <th>HostName</th>
                                        <th>DateStart</th>
                                        <th>DateEnd</th>
                                        <th>TimeStart</th>
                                        <th>TimeEnd</th>
                                        <th>Status</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-body -->

        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12" id="boxMyRequest">
        <div class="box ShimanoBox">
            <div class="box-header">
                My Request
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"
                            title="Collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <div class="row" id="RowMyRequest">
                    <div class="col-md-12">
                        <div style="width:100%; margin:0 auto;">
                            <table id="MyRequest" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        @*<th>No</th>
                                            <th>LogId</th>
                                            <th>Area</th>
                                            <th>Visitor Type</th>
                                            <th>Host Name</th>
                                            <th>Visitor Name</th>
                                            <th>Remark</th>
                                            <th>DateStart</th>
                                            <th>DateEnd</th>
                                            <th>TimeStart</th>
                                            <th>TimeEnd</th>
                                            <th>Status</th>*@
                                        <th></th>
                                        <th>No.</th>
                                        <th>RefNo.</th>
                                        <th>Area</th>
                                        <th>VisitorType</th>
                                        <th>HostName</th>
                                        <th>DateStart</th>
                                        <th>DateEnd</th>
                                        <th>TimeStart</th>
                                        <th>TimeEnd</th>
                                        <th>Status</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-body -->

        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12" id="boxHistoryTask">
        <div class="box ShimanoBox">
            <div class="box-header">
                History My Task
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"
                            title="Collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <div class="row" id="RowHistoryTask">
                    <div class="col-md-12">
                        <div style="width:100%; margin:0 auto;">
                            <table id="myHistoryGrid" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        @*<th>No</th>
                                        <th>LogId</th>
                                        <th>Area</th>
                                        <th>Visitor Type</th>
                                        <th>Host Name</th>
                                        <th>Visitor Name</th>
                                        <th>Remark</th>
                                        <th>DateStart</th>
                                        <th>DateEnd</th>
                                        <th>TimeStart</th>
                                        <th>TimeEnd</th>
                                        <th>Status</th>*@
                                        <th></th>
                                        <th>No.</th>
                                        <th>RefNo.</th>
                                        <th>Area</th>
                                        <th>VisitorType</th>
                                        <th>HostName</th>
                                        <th>DateStart</th>
                                        <th>DateEnd</th>
                                        <th>TimeStart</th>
                                        <th>TimeEnd</th>
                                        <th>Status</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-body -->

        </div>
    </div>
</div>
<div class="modal fade" id="modalApprovalAction" hidden="hidden">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" style="color:white" class="close" data-dismiss="modal">&times;</a>
                <h3 class="modal-title" id="modalApprovalTitle">Appointment Approval</h3>
            </div>
            <div class="modal-body" id="myModalBodyDiv1">
                <div class="row">
                    <div class="col-md-12">
                    @Html.Hidden("LogId")
                    @Html.Hidden("Status")
                        <p id="modalApprovalBody">Do you want to Approve this request?</p>
                    </div>
                    @*<div class="col-md-12">
                        <div class="col-md-3">HostName:</div>
                        <div class="col-md-3"><p id="modalHostName">Suharjo Ng</p></div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-3">VisitorType:</div>
                        <div class="col-md-3"><p id="modalVisitorType">Suharjo Ng</p></div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-3">Date:</div>
                        <div class="col-md-9">
                            <div class="col-md-3" id="modalStartDate" style="text-align:left;padding-left:0px;padding-right:0px;">2021-11-08</div>
                            <div class="col-md-3"  style="text-align:left;padding-left:0px;padding-right:0px;">until</div>
                            <div class="col-md-3" id="modalEndDate" style="text-align:left;padding-left:0px;padding-right:0px;">2021-11-08</div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-3">Time:</div>
                        <div class="col-md-9">
                            <div class="col-md-3" id="modalStartTime" style="text-align:left;padding-left:0px;padding-right:0px;">09:00</div>
                            <div class="col-md-3" style="text-align:left;padding-left:0px;padding-right:0px;">-</div>
                            <div class="col-md-3" id="modalEndTime" style="text-align:left;padding-left:0px;padding-right:0px;">21:00</div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-3">Remarks:</div>
                        <div class="col-md-9" id="modalRemarks"></div>
                    </div>
                </div>
                <div class="row" id="rowRemark" hidden="hidden">
                    <div class="col-md-12">
                        <div class="form-group">
                            @Html.Label("Remark", "Reject Remark: ")<br />
                            @Html.TextArea("Remark","Approve", 3, 3, new { @class = "k-textbox", style = "width: 100%; padding:10px", required = "required" })
                        </div>
                    </div>
                </div>*@
                    <div class="col-md-12">
                        <table style="padding-left:20px;">
                            <tr>
                                <td>Host Name</td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px;">:</td>
                                <td colspan="3" style="font-weight: bold;"><div id="modalHostName">Lee Hui Xin</div></td>
                            </tr>
                            <tr>
                                <td>Visitor Type</td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px;">:</td>
                                <td colspan="3" style="font-weight: bold;"><div id="modalVisitorType">OFF-HOUR VISIT</div></td>
                            </tr>
                            <tr>
                                <td>Date</td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px;">:</td>
                                <td style="font-weight: bold;"><div id="modalStartDate">2021-11-14</div></td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px; text-align:center;">until</td>
                                <td style="font-weight: bold;"><div id="modalEndDate">2021-11-14</div></td>
                            </tr>
                            <tr>
                                <td>Time</td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px;">:</td>
                                <td style="font-weight: bold;"><div id="modalStartTime">07:00:00 AM</div></td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px; text-align:center;">-</td>
                                <td style="font-weight: bold;"><div id="modalEndTime">07:00:00 AM</div></td>
                            </tr>
                            <tr>
                                <td>Remarks</td>
                                <td style="padding-left:10px; padding-right:10px; padding-top:5px; padding-bottom:5px;">:</td>
                                <td colspan="3" style="font-weight: bold;"><div id="modalRemarks">Meeting</div></td>
                            </tr>
                        </table>
                        <div class="row" id="rowRemark" hidden="hidden">
                            <div class="col-md-12">
                                <div class="form-group">
                                    @Html.Label("Remark", "Reject Remark: ")<span style="color:red;">*</span><br />
                                    @Html.TextArea("Remark", "Approve", 3, 3, new { @class = "k-textbox", style = "width: 100%; padding:10px", required = "required" })
                                </div>
                            </div>
                        </div>
                    </div>
                    
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="ApprovalActionAjax()" id="btnConfirm"><i class="fa fa-check"></i> OK</button>
                <a href="#" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times"></i> Cancel</a>
            </div>
        </div>
    </div>
</div>
    </div>
<div class="modal fade bd-example-modal-lg" id="ModalApprovalStatus" data-backdrop="static">
    <div class="modal-dialog modal-dialog-scrollable" role="document" style="max-width: 80%;width: auto !important;">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Approval Status</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body" style="max-height: calc(100vh - 200px);overflow-y: auto;">
                <table class="table table-striped" id="tblApprovalStatus">
                    <thead>
                        <tr>
                            <th>Approval Level</th>
                            <th>Approval</th>
                            <th>Delegate To</th>
                            <th>Approved By</th>
                            <th>Department</th>
                            <th>Visitor Type</th>
                            <th>Category</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                @*<button type="button" class="btn btn-info" data-dismiss="modal" disabled id="btnConfirmSubmit" onclick="confirmSubmit()">Submit</button>*@
            </div>

        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        checkAuthorize();
        funcRenderTableMyRequest();
        funcRenderTableMyTask();
        funcRenderTableistoryMyTask();
        //funcRenderTableApprovalStatus();
    })
</script>
<script>
    function ApproveVisitor(LogId,HostName, VisitorType, StartDate,EndDate, StartTime,EndTime,Remarks) {
        $('#modalApprovalAction').modal('show');
        $('#modalApprovalTitle').text('Appointment Approval');
        $('#modalApprovalBody').text('Do you want to Approve this request?');
        //
        $('#LogId').val(LogId);
        $('#modalHostName').text(HostName);
        $('#modalVisitorType').text(VisitorType);
        $('#modalStartDate').text(StartDate);
        $('#modalEndDate').text(EndDate);
        $('#modalStartTime').text(StartTime);
        $('#modalEndTime').text(EndTime);
        $('#modalRemarks').text(Remarks);
        $('#Status').val('APPROVED');
        $('#Remark').val("APPROVED");
        $('#rowRemark').hide("");

    }
</script>
<script>
    function RejectVisitor(LogId, HostName, VisitorType, StartDate, EndDate, StartTime, EndTime, Remarks) {
        $('#modalApprovalAction').modal('show');
        $('#modalApprovalTitle').text('Appointment Approval');
        $('#modalApprovalBody').text('Do you want to Reject this request?');
        //
        $('#LogId').val(LogId);
        $('#modalHostName').text(HostName);
        $('#modalVisitorType').text(VisitorType);
        $('#modalStartDate').text(StartDate);
        $('#modalEndDate').text(EndDate);
        $('#modalStartTime').text(StartTime);
        $('#modalEndTime').text(EndTime);
        $('#modalRemarks').text(Remarks);
        $('#Status').val('REJECTED');
        $('#Remark').val("");
        $('#rowRemark').show("slow");
    }
</script>
<script>
    function showApprovalLevel(LogId)
    {
        $.ajax({
            //url: "../Approval/ShowApprovalStatus",
            url: '@Url.Action("ShowApprovalStatus", "Approval")',
            method: "POST",
            dataType: "JSON",
            data: {
                LogId: LogId
            },
            success: function (j) {
                //console.log(j.xdataTable);
                //tblApprovalStatus.mDataTable.clear();
                //$.each(j.xdataTable, function (i, st) {
                //    tblApprovalStatus.mDataTable.row.add(st);
                //});
                //tblApprovalStatus.mDataTable.draw();
                var PositionApprovalStatus = $('#tblApprovalStatus');
                var style = "";
                PositionApprovalStatus.empty();
                if (j.xdataTable.length > 0)
                {
                    var itemApprovalStatus = "";
                    itemApprovalStatus += '<table class="table">';
                    itemApprovalStatus += '<tr>';
                    itemApprovalStatus += '<th style="text-align:center;">Approval Level</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Approval</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Delegate To</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Approved By</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Department</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Visitor Type</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Category</th>';
                    itemApprovalStatus += '<th style="text-align:center;">Status</th>';
                    itemApprovalStatus += '</tr>';
                    for (var x = 0; x < j.xdataTable.length; x++)
                    {
                        if (j.xdataTable[x].Status == "APPROVED")
                        {
                            style = "style='background-color: green; color: white;' ";
                        }
                        else if (j.xdataTable[x].Status == "WAITING APPROVAL")
                        {
                            style = "style='background-color: grey; color: white;' ";
                        }
                        else if (j.xdataTable[x].Status == "REJECTED")
                        {
                            style = "style='background-color: red; color: white;' ";
                        }
                        else
                        {
                            style = "";
                        }
                        
                        itemApprovalStatus += '<tr '+ style +' >';
                        itemApprovalStatus += '<td>' + j.xdataTable[x].ApprovalLevel + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].Approval + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].DelegateTo + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].ApprovedBy + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].Department + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].VisitorType + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].Category + '</td>'
                        itemApprovalStatus += '<td>' + j.xdataTable[x].Status + '</td>'
                        itemApprovalStatus += '</tr>';

                    }

                    itemApprovalStatus += '</table>';
                }
                PositionApprovalStatus.append(itemApprovalStatus);
                $('#ModalApprovalStatus').modal('show');
            },
            error: function (xhr, error, text) {
                toastr.error("Failed Query Get View Table, Please contact IT")
            }
        });
        //$('#ModalApprovalStatus').modal('toggle');
        //console.log("munculkan modal approval status");
    }
</script>
<script id="AJAX">
    $(function () {
        $('#chkDelegate').change(function () {
            var isDelegate = $(this).prop('checked');
            $.ajax({
                url: '@Url.Action("ChangeDelegate", "Approval")',
                cache: false,
                type: "POST",
                data: { isDelegate: isDelegate },
                success: function (data) {

                },
                error: function () {
                    toastr.error("Something wrong with this, please call IT!", "ERROR!");
                }

            })
        })
    })
    function checkDelegate() {
        $.ajax({
            url: '@Url.Action("CheckDelegate", "Approval")',
            cache: false,
            type: "POST",
            success: function (data) {
                if (data.Success === true) {
                    $('#chkDelegate').bootstrapToggle('on')
                }
                else {
                    $('#chkDelegate').bootstrapToggle('off')
                }
            },
            error: function () {
                toastr.error("Something wrong with this, please call IT!", "ERROR!");
            }

        })
    }
    function checkAuthorize() {
        $.ajax({
            url: '@Url.Action("CheckAuthorize", "Approval")',
            cache: false,
            type: "POST", 
            success: function (data) {
                if (data.Success === true) {
                    //toastr.success("You have Access Right to Approve", "Success!");
                    toastr.success(data.Message, "Success!") //Modified by CANICE 20210801
                    showMyTask();
                    ShowMyRequest();
                    ShowHistoryMyTask();
                    checkDelegate();
                    //showMyHistoryTask();
                }
                else {
                    toastr.warning("You dont have Access Right To Approve", "Warning!");
                    ShowMyRequest();
                    //$('#boxHistoryTask').prop("hidden", "hidden");
                }
            },
            error: function () {
                toastr.error("Something wrong with this, please call IT!", "ERROR!");
            }

        });
    }
    function ApprovalActionAjax() {
        var LogId  = $("#LogId").val();
        var Status = $("#Status").val();
        var Remark = $("#Remark").val().replace(/'/g, '`');
        console.log(Status);
        if (Status == "APPROVED")
        {
            $.ajax({
                url: '@Url.Action("ApprovalAction", "Approval")',
                cache: false,
                type: "POST",
                data: { LogId: LogId, Status: Status, Remark: Remark },
                success: function (data) {
                    if (data.Success == true) {
                        toastr.success(data.Messagge, "Success!");
                        $('#modalApprovalAction').modal('hide');
                        showMyTask();
                        ShowMyRequest();
                        ShowHistoryMyTask();
                    }
                    else {
                        $('#modalApprovalAction').modal('hide');
                        toastr.warning(data.Messagge, "Warning!");
                        showMyTask();
                        ShowMyRequest();
                        ShowHistoryMyTask();
                    }
                },
            });
        }
        else
        {
            if(Remark == "")
            {
                toastr.error("Remark cannot empty.", "Error!");
                $("#Remark").focus();
            }
            else
            {
                $.ajax({
                    url: '@Url.Action("ApprovalAction", "Approval")',
                    cache: false,
                    type: "POST",
                    data: { LogId: LogId, Status: Status, Remark: Remark },
                    success: function (data) {
                        if (data.Success === true) {
                            toastr.success(data.message, "Success!");
                            $('#modalApprovalAction').modal('hide');
                            showMyTask();
                            ShowMyRequest();
                            ShowHistoryMyTask();
                        }
                        else {
                            $('#modalApprovalAction').modal('hide');
                            toastr.warning(data.message, "Warning!");
                            showMyTask();
                            ShowMyRequest();
                            ShowHistoryMyTask();
                        }
                    },
                });
            }
        }
    }
</script>
<script id="MyRequestRenderTable">
    function funcRenderTableMyRequest() {
        var table = "";
        var options = "";

        // begin first table
        options = {
            responsive: true,
            paging: true,
            scrollX: true,
            columns: [
                {
                    "class": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": ''
                },
                { "data": "Number" },
                { "data": "LogId" },
                { "data": "Area" },
                { "data": "VisitorType" },
                { "data": "HostName" },
                { "data": "DateStart" },
                { "data": "DateEnd" },
                { "data": "TimeStart" },
                { "data": "TimeEnd" },
                { "data": "Status" },
                { "data": "Remark" },
            ],
            columnDefs: [
                {
                    targets: 10,
                    render: function (data, type, full, meta) {
                        var output = '';
                        output += '<label onclick="showApprovalLevel(\'' + full.LogId + '\')">' + full.Status + '</label>';
                        return output;
                    }
                },
            ],
        };

        table = $('#MyRequest').DataTable(options);
        MyRequest.mDataTable = table;

        //CHILD
        $('#MyRequest tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var data = table.row(this).data();
            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                $.ajax({
                    //url: "../Approval/DetailVisitor",
                    url: '@Url.Action("DetailVisitor", "Approval")',
                    method: "POST",
                    dataType: "JSON",
                    data: {
                        LogId: data.LogId,
                    },
                    success: function (j) {
                        //console.log(j.xdatatable);
                        var value = '<table class="table table-bordered" style="margin-top: 13px !important; width:50% !important; border:1px solid #cccccc">'
                        value += '<thead>'
                        value += '<tr style="color:black;background-color:white;border-color:Transparent;font-weight:bold;border:1px solid #cccccc">'
                        value += '<th>No</th>'
                        value += '<th>Visitor Name</th>'
                        value += '<th>Company</th>'
                        value += '<th>Status</th>'
                        value += '</tr>'
                        value += '</thead>'
                        value += '<tbody>'
                        for (var x = 0; x < j.xdataTable.length; x++) {
                            value += '<tr>'
                            value += '<td>' + j.xdataTable[x].Number + '</td>'
                            value += '<td>' + j.xdataTable[x].FullName + '</td>'
                            value += '<td>' + j.xdataTable[x].Company + '</td>'
                            value += '<td>' + j.xdataTable[x].Status + '</td>'
                            value += '</tr>'
                        }
                        value += '</tbody>'
                        value += '</table>'
                        row.child(value).show();
                        tr.addClass('shown');
                    },
                    error: function (xhr, error, text) {
                        toastr.error("Failed get child process, Please contact IT")
                    }
                })
            }

        });
        //END

    }
</script>
<script id="MyTaskRenderTable">
    function funcRenderTableMyTask() {
        var table = "";
        var options = "";

        // begin first table
        options = {
            responsive: true,
            paging: true,
            scrollX: true,
            columns: [
                {
                    "class": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": ''
                },
                { "data": "Number" },
                { "data": null },
                { "data": "LogId" },
                { "data": "Area" },
                { "data": "VisitorType" },
                { "data": "HostName" },
                { "data": "DateStart" },
                { "data": "DateEnd" },
                { "data": "TimeStart" },
                { "data": "TimeEnd" },
                { "data": "Status" },
                { "data": "Remark" },
            ],
            columnDefs: [
                {
                    targets: 2,
                    render: function (data, type, full, meta) {
                        var output = ``;
                        output += '<button class="btn btn-info"  onclick="ApproveVisitor(\'' + full.LogId + '\',\'' + full.HostName + '\',\'' + full.VisitorType + '\',\'' + full.DateStart + '\',\'' + full.DateEnd + '\',\'' + full.TimeStart + '\',\'' + full.TimeEnd + '\',\'' + full.Remark + '\')">Approve</button> - '
                        output += '<button class="btn btn-danger"  onclick="RejectVisitor(\'' + full.LogId + '\',\'' + full.HostName + '\',\'' + full.VisitorType + '\',\'' + full.DateStart + '\',\'' + full.DateEnd + '\',\'' + full.TimeStart + '\',\'' + full.TimeEnd + '\',\'' + full.Remark + '\')">Reject</button>'
                        return output;
                    },
                    
                },
                {
                    targets: 11,
                    render: function (data, type, full, meta) {
                        var output = '';
                        output += '<label onclick="showApprovalLevel(\'' + full.LogId + '\')">' + full.Status + '</label>';
                        return output;
                    }
                },
                { "width": "20px", "targets": 6 },
            ],
        };

        table = $('#myTaskGrid').DataTable(options);
        myTaskGrid.mDataTable = table;

        //CHILD
        $('#myTaskGrid tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var data = table.row(this).data();
            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                $.ajax({
                    //url: "../Approval/DetailVisitor",
                    url: '@Url.Action("DetailVisitor", "Approval")',
                    method: "POST",
                    dataType: "JSON",
                    data: {
                        LogId: data.LogId,
                    },
                    success: function (j) {
                        //console.log(j.xdatatable);
                        var value = '<table class="table table-bordered" style="margin-top: 13px !important; width:50% !important; border:1px solid #cccccc">'
                        value += '<thead>'
                        value += '<tr style="color:black;background-color:white;font-weight:bold; border:1px solid #cccccc">'
                        value += '<th>No</th>'
                        value += '<th>Visitor Name</th>'
                        value += '<th>Company</th>'
                        value += '<th>Status</th>'
                        value += '</tr>'
                        value += '</thead>'
                        value += '<tbody>'
                        for (var x = 0; x < j.xdataTable.length; x++) {
                            value += '<tr>'
                            value += '<td>' + j.xdataTable[x].Number + '</td>'
                            value += '<td>' + j.xdataTable[x].FullName + '</td>'
                            value += '<td>' + j.xdataTable[x].Company + '</td>'
                            value += '<td>' + j.xdataTable[x].Status + '</td>'
                            value += '</tr>'
                        }
                        value += '</tbody>'
                        value += '</table>'
                        row.child(value).show();
                        tr.addClass('shown');
                    },
                    error: function (xhr, error, text) {
                        toastr.error("Failed get child process, Please contact IT")
                    }
                })
            }

        });
        //END

    }
</script>
<script id="HistoryMyTaskRenderTable">
    function funcRenderTableistoryMyTask() {
        var table = "";
        var options = "";

        // begin first table
        options = {
            responsive: true,
            paging: true,
            scrollX:true,
            columns: [
                {
                    "class": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": ''
                },
                { "data": "Number" },
                { "data": "LogId" },
                { "data": "Area" },
                { "data": "VisitorType" },
                { "data": "HostName" },
                { "data": "DateStart" },
                { "data": "DateEnd" },
                { "data": "TimeStart" },
                { "data": "TimeEnd" },
                { "data": "Status" },
                { "data": "Remark" },
            ],
            columnDefs: [
                {
                    targets: 10,
                    render: function (data, type, full, meta) {
                        var output = '';
                        output += '<label onclick="showApprovalLevel(\'' + full.LogId + '\')">' + full.Status + '</label>';
                        return output;
                    }
                },
            ],
        };

        table = $('#myHistoryGrid').DataTable(options);
        myHistoryGrid.mDataTable = table;

        //CHILD
        $('#myHistoryGrid tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);
            var data = table.row(this).data();
            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                $.ajax({
                    //url: "../Approval/DetailVisitor",
                    url: '@Url.Action("DetailVisitor", "Approval")',
                    method: "POST",
                    dataType: "JSON",
                    data: {
                        LogId: data.LogId,
                    },
                    success: function (j) {
                        //console.log(j.xdatatable);
                        var value = '<table class="table table-bordered" style="margin-top: 13px !important; width:50% !important; border:1px solid #cccccc">'
                        value += '<thead>'
                        value += '<tr style="color:black;background-color:white;border-color:Transparent;font-weight:bold;border:1px solid #cccccc">'
                        value += '<th>No</th>'
                        value += '<th>Visitor Name</th>'
                        value += '<th>Company</th>'
                        value += '<th>Status</th>'
                        value += '</tr>'
                        value += '</thead>'
                        value += '<tbody>'
                        for (var x = 0; x < j.xdataTable.length; x++) {
                            value += '<tr>'
                            value += '<td>' + j.xdataTable[x].Number + '</td>'
                            value += '<td>' + j.xdataTable[x].FullName + '</td>'
                            value += '<td>' + j.xdataTable[x].Company + '</td>'
                            value += '<td>' + j.xdataTable[x].Status + '</td>'
                            value += '</tr>'
                        }
                        value += '</tbody>'
                        value += '</table>'
                        row.child(value).show();
                        tr.addClass('shown');
                    },
                    error: function (xhr, error, text) {
                        toastr.error("Failed get child process, Please contact IT")
                    }
                })
            }

        });
        //END

    }
</script>
<script id="ApprovalStatus">
    function funcRenderTableApprovalStatus() {
        var table = "";
        var options = "";

        // begin first table
        options = {
            responsive: true,
            paging: true,

            columns: [
                { "data": "ApprovalLevel" },
                { "data": "Approval" },
                { "data": "DelegateTo" },
                { "data": "ApprovedBy" },
                { "data": "Department" },
                { "data": "VisitorType" },
                { "data": "Category" },
                { "data": "Status" },
            ],
        };

        table = $('#tblApprovalStatus').DataTable(options);
        tblApprovalStatus.mDataTable = table;
    }
</script>
